{{- if .Values.elasticsearch.enabled }}
# StatefulSet for Elasticsearch
# Provides persistent storage and stable network identities

---
# Elasticsearch Service
apiVersion: v1
kind: Service
metadata:
  name: elasticsearch
  labels:
    app: elasticsearch
spec:
  type: ClusterIP
  ports:
    - port: 9200
      name: http
      targetPort: 9200
    - port: 9300
      name: transport
      targetPort: 9300
  selector:
    app: elasticsearch

---
# Elasticsearch StatefulSet
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: elasticsearch
  labels:
    app: elasticsearch
spec:
  serviceName: elasticsearch  # Headless service for stable network IDs
  replicas: {{ .Values.elasticsearch.data.replicaCount }}

  selector:
    matchLabels:
      app: elasticsearch

  template:
    metadata:
      labels:
        app: elasticsearch
    spec:
      # Init container to set proper filesystem permissions
      initContainers:
        - name: fix-permissions
          image: busybox:1.36
          command: ["sh", "-c", "chown -R 1000:1000 /usr/share/elasticsearch/data"]
          volumeMounts:
            - name: data
              mountPath: /usr/share/elasticsearch/data
          securityContext:
            runAsUser: 0  # Run as root to change permissions

      containers:
        - name: elasticsearch
          image: docker.elastic.co/elasticsearch/elasticsearch:8.12.0

          # Expose ports
          ports:
            - containerPort: 9200
              name: http
            - containerPort: 9300
              name: transport

          # Environment variables for single-node cluster
          env:
            - name: discovery.type
              value: "single-node"  # Single-node for dev (use cluster for prod)
            - name: ES_JAVA_OPTS
              value: "-Xms512m -Xmx512m"  # JVM heap size
            - name: xpack.security.enabled
              value: "false"  # Disable security for dev (enable for prod)

          # Volume mount for persistent data
          volumeMounts:
            - name: data
              mountPath: /usr/share/elasticsearch/data

          # Resource limits
          resources:
            {{- toYaml .Values.elasticsearch.resources | nindent 12 }}

          # Readiness probe - check if ES is ready
          readinessProbe:
            httpGet:
              path: /_cluster/health
              port: 9200
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5

  # Volume claim template for persistent storage
  {{- if .Values.elasticsearch.persistence.enabled }}
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: [ "ReadWriteOnce" ]
        {{- if .Values.elasticsearch.persistence.storageClass }}
        storageClassName: {{ .Values.elasticsearch.persistence.storageClass }}
        {{- end }}
        resources:
          requests:
            storage: {{ .Values.elasticsearch.persistence.size }}
  {{- else }}
  # Use emptyDir if persistence is disabled (data lost on pod restart)
  volumes:
    - name: data
      emptyDir: {}
  {{- end }}
{{- end }}
